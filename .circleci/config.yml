version: "2.1"
orbs:
    aws-ecr: circleci/aws-ecr@7.3.0
    aws-cli: circleci/aws-cli@2.0
jobs:
  configure-role-arn:
    machine:
      image: circleci/classic:201808-01
    steps:
        - run:
             name: "export env var."
             command: |
                ASSUME_ROLE_OUTPUT=$(aws sts assume-role --role-arn arn:aws:sts::695292474035:assumed-role/AWSReservedSSO_nclouds-devops_7a27a6c6e0019cb2/sachin@nclouds.com --role-session-name jenkins)
                ASSUME_ROLE_ENVIRONMENT=$(echo $ASSUME_ROLE_OUTPUT | jq -r '.Credentials | .["AWS_ACCESS_KEY_ID"] = .AccessKeyId | .["AWS_SECRET_ACCESS_KEY"] = .SecretAccessKey | .["AWS_SESSION_TOKEN"] = .SessionToken | del(.AccessKeyId, .SecretAccessKey, .SessionToken, .Expiration) | to_entries[] | "export \(.key)=\(.value)"')
                eval $ASSUME_ROLE_ENVIRONMENT
        
workflows:
    aws_cli:
        jobs:
           - configure-role-arn
           - aws-ecr/build-and-push-image:
               repo: $repo
               tag: $tag
               

